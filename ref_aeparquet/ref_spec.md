# main.py 実行仕様書

## 1. 概要
本スクリプトはシステムのエントリーポイントとして、以下の処理を順次実行します:
- **設定ファイル（settings.ini）の読み込み**
- **アドエビス関連処理によるデータ取得**（`perform_adebis_operations` の実行）
- **CSVファイルの統合処理**（`integrate_csv_files` の実行）
- **CSVファイルのParquet形式への変換**（`convert_csv_to_parquet` の実行）

各処理の状況はロギングにより記録され、例外発生時には詳細なエラーメッセージとトレースバック情報がログに出力され、さらに Slack へエラー通知が行われます。

## 2. 実行前の前提条件
- Python 3.x以上の環境で実行すること
- 同一ディレクトリに有効な設定ファイル `settings.ini` が存在すること（UTF-8 エンコード）
- `adebis_operations`、`csv_integration`、`csv_to_parquet`、`slack_notify`、`my_logging` 等の依存モジュールが正しく実装・インポート可能であること
- 必要に応じて、各モジュールに記述された詳細な動作仕様や入出力の確認を行うこと

## 3. 入力
- **設定ファイル:** `settings.ini`  
  ※ 本ファイルには、データ取得、CSV 統合、Parquet 変換の各処理に必要な各種パラメータおよび Slack 通知用の設定（Webhook URL 等）が記載されます。

## 4. 出力
- **ログ出力:**  
  `my_logging.setup_department_logger` により初期設定されたロガーが、各処理開始時・終了時、及びエラー発生時にログを記録します。
- **エラー通知:**  
  例外発生時、`traceback` を用いた詳細なエラーメッセージがログに出力され、`slack_notify.send_slack_error_message` により Slack へ通知が送信されます。
- **データ出力:**  
  CSV 統合および Parquet 変換処理の結果、統合後の CSV ファイルや生成された Parquet ファイルが出力されます（各機能の実装内容に依存）。

## 5. 実行フロー
1. **スクリプト開始**  
   エントリーポイントである `main()` 関数が呼び出されます。
2. **設定ファイルの読み込み**  
   `configparser` を用いて `settings.ini` を UTF-8 エンコードで読み込み、設定情報を `config` オブジェクトに格納します。
3. **アドエビス操作の実行**  
   ロガーで「アドエビスからデータを取得中...」のメッセージを記録し、`perform_adebis_operations(config)` を実行してアドエビス関連のデータ取得処理を開始します。
4. **CSV ファイル統合処理の実行**  
   ロガーで「CSV ファイルを統合中...」のメッセージを記録し、`integrate_csv_files(config)` を実行して複数の CSV ファイルを統合します。
5. **CSV から Parquet への変換処理**  
   ロガーで「CSV ファイルを Parquet に変換中...」のメッセージを記録し、`convert_csv_to_parquet(config)` を呼び出して統合 CSV ファイルから Parquet 形式へ変換します。
6. **正常終了**  
   全ての処理が正常に完了した場合、ロガーで「すべての処理が完了しました。」のメッセージを記録してスクリプトが終了します。
7. **エラー発生時の処理**  
   - `try-except` ブロックにより、実行中に例外が発生した場合は、`traceback.format_exc()` を用いて詳細なスタックトレースとエラーメッセージを取得し、ログに出力します。
   - 再度 `settings.ini` を読み込んだ上で、`slack_notify.send_slack_error_message(e, config=config)` を実行し、エラー内容を Slack に通知します。

## 6. エラー処理とログ出力
- 各処理は `try` ブロック内で実行され、例外発生時には `except` ブロックによりエラーメッセージおよびスタックトレース情報がログファイルに記録されます。
- Slack 通知のため、エラー発生時には再度設定ファイルを参照し、通知処理が実施されます。
- ログは `setup_department_logger` により設定され、各処理毎に詳細な情報が記録されます。

## 7. 補足
- 本仕様は `ref_aeparquet/main.py` の実装に基づいており、各連携モジュール（例: `adebis_operations` など）の内部動作は各モジュールの実装仕様に依存します。
- 実行環境の整備、及び設定ファイルの事前確認が必要です。
- 出力されるログやエラー通知をもとに、処理状況や障害発生時の対処を行います。