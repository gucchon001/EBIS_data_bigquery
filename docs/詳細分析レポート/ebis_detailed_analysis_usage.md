# アドエビス詳細分析ページCSVダウンロード 使用手順

## 1. 概要

このドキュメントでは、アドエビス（AD EBiS）の詳細分析ページからCSVデータを自動ダウンロードする機能の使用方法について説明します。このツールを使用することで、指定した日付範囲のデータを自動的にダウンロードし、適切な名前で保存することができます。

## 2. 前提条件

- Python 3.9以上がインストールされていること
- 必要なPythonパッケージがインストールされていること
- AD EBiSのアカウント情報が環境変数または設定ファイルに正しく設定されていること
- Chromeブラウザがインストールされていること

### 2.1 環境設定

環境変数または`config/secrets.env`ファイルに以下の値を設定してください：

```
EBIS_USERNAME=（ユーザー名）
EBIS_PASSWORD=（パスワード）
EBIS_ACCOUNT_KEY=（アカウントキー）
```

## 3. 基本的な使用方法

### 3.1 コマンドライン実行

基本的なコマンド形式は以下の通りです：

```bash
python -m src.ebis_download_csv [オプション]
```

デフォルトでは、実行日の前日のデータをダウンロードします。

### 3.2 オプション

以下のオプションを指定できます：

| オプション | 説明 | 例 |
|------------|------|-----|
| `--date` | 単一日付を指定 | `--date 2023-12-01` |
| `--start-date` | 開始日を指定 | `--start-date 2023-12-01` |
| `--end-date` | 終了日を指定（`--start-date`と併用） | `--end-date 2023-12-31` |
| `--account` | アカウント番号を指定 | `--account 2` |
| `--output-dir` | 出力ディレクトリを指定 | `--output-dir data/csv` |
| `--headless` | ヘッドレスモードで実行 | `--headless` |
| `--verify` | 検証モード（ダウンロードなし） | `--verify` |

### 3.3 実行例

#### 前日のデータをダウンロード：

```bash
python -m src.ebis_download_csv
```

#### 特定の日付のデータをダウンロード：

```bash
python -m src.ebis_download_csv --date 2023-12-01
```

#### 特定の期間のデータをダウンロード：

```bash
python -m src.ebis_download_csv --start-date 2023-12-01 --end-date 2023-12-31
```

#### 異なるアカウントでダウンロード：

```bash
python -m src.ebis_download_csv --account 2
```

#### 特定のディレクトリに出力：

```bash
python -m src.ebis_download_csv --output-dir data/ebis_reports
```

#### ヘッドレスモードで実行：

```bash
python -m src.ebis_download_csv --date 2023-12-01 --headless
```

## 4. 設定ファイルのカスタマイズ

### 4.1 settings.ini

`config/settings.ini`ファイルで以下の設定をカスタマイズできます：

```ini
[BROWSER]
headless = false  # ヘッドレスモードを有効/無効

[AdEBIS]
url_details = https://bishamon.ebis.ne.jp/detail_analyze  # 詳細分析ページのURL

[Download]
timeout = 90  # ダウンロード待機タイムアウト（秒）
directory = data/downloads  # ダウンロードディレクトリ
```

### 4.2 セレクタの調整

ウェブページの構造が変更された場合は、`config/selectors.csv`ファイルのセレクタを更新する必要があります。セレクタ更新の手順については、管理者にお問い合わせください。

## 5. 出力ファイル

### 5.1 ファイル形式

ダウンロードされたCSVファイルは以下の命名規則で保存されます：

```
YYYYMMDD_ebis_SS_CV.csv
```

例：`20231201_ebis_SS_CV.csv`

### 5.2 出力例

```csv
媒体,広告グループ,クリック数,CV数,CV率,CV単価
Google広告,ブランド名,123,45,36.59%,¥123
Google広告,一般検索,456,78,17.11%,¥456
Yahoo!広告,ブランド名,789,12,1.52%,¥789
...
```

## 6. トラブルシューティング

### 6.1 ログイン関連の問題

**症状**: 「ログインに失敗しました」というエラーが表示される

**解決策**:
1. 環境変数のユーザー名、パスワード、アカウントキーが正しいか確認
2. ネットワーク接続を確認
3. AD EBiSのアカウントが正常に機能しているか確認

### 6.2 セレクタエラー

**症状**: 「エレメントが見つかりません」というエラーが表示される

**解決策**:
1. ログファイルでどのセレクタが問題か確認
2. AD EBiSのインターフェースが変更されていないか確認
3. 管理者にセレクタの更新を依頼

### 6.3 ダウンロード待機タイムアウト

**症状**: 「ダウンロードファイルが見つかりません」というエラーが表示される

**解決策**:
1. `settings.ini`ファイルの`timeout`値を増やす
2. ネットワーク接続の速度を確認
3. ダウンロードディレクトリに書き込み権限があるか確認

## 7. ヘルプの表示

コマンドラインオプションの詳細を表示するには：

```bash
python -m src.ebis_download_csv --help
```

## 8. よくある質問（FAQ）

### Q: 複数のアカウントからデータをダウンロードできますか？
A: はい、`--account`オプションで指定できます。ただし、環境変数に各アカウントの認証情報を設定する必要があります。

### Q: 日付範囲を指定すると、各日のファイルが作成されますか？
A: いいえ、日付範囲を指定した場合、その期間のデータが集約された1つのファイルが作成されます。ファイル名は開始日の日付で生成されます。

### Q: エラーが発生した場合、どこでログを確認できますか？
A: ログファイルは`logs`ディレクトリに保存されます。最新のログファイルを確認してください。

### Q: ヘッドレスモードとは何ですか？
A: ブラウザのUIを表示せずにバックグラウンドで処理を実行するモードです。サーバーやバッチ処理で使用する場合に適しています。

### Q: どのような場合に検証モード（--verify）を使用すべきですか？
A: 設定が正しいかを確認する場合や、ログインテストを行いたい場合に使用します。このモードではログインまでを実行し、ダウンロード処理は行いません。 